# Database Infrastructure

This directory contains all database-related infrastructure code including schema definitions, migrations, and the database client configuration.

## Structure

- `schema/` - Drizzle ORM schema definitions
- `migrations/` - Database migration files (auto-generated)
- `client.ts` - Database connection and Drizzle client setup
- `base-repository.ts` - Base repository class with soft-delete support

## Soft Delete Pattern

This template implements soft-delete by default for all entities. Instead of permanently removing records from the database, a `deletedAt` timestamp is set.

### Benefits

- **Data Recovery**: Easily restore accidentally deleted data
- **Audit Trail**: Maintain history of all data
- **Referential Integrity**: Avoid cascade deletion issues
- **Compliance**: Meet data retention requirements

### Usage

All repositories extend `BaseRepository` which provides:

```typescript
// Soft delete (default behavior)
await repository.softDelete(id);

// Hard delete (permanent removal)
await repository.hardDelete(id);

// Restore soft-deleted record
await repository.restore(id);

// Find including soft-deleted
await repository.findAll(true); // includeSoftDeleted = true
await repository.findById(id, true);
```

### Schema Requirements

To support soft-delete, all tables should include:

```typescript
deletedAt: timestamp('deleted_at')
```

## Database Client

The database client is configured in `client.ts`:

- Uses `postgres` driver for connection pooling
- Integrates with Drizzle ORM
- Exports typed `db` instance for queries

## Adding New Entities

1. Create schema in `schema/` directory:

```typescript
// schema/posts.ts
import { pgTable, text, timestamp, uuid } from 'drizzle-orm/pg-core';

export const posts = pgTable('posts', {
  id: uuid('id').defaultRandom().primaryKey(),
  title: text('title').notNull(),
  content: text('content'),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
  deletedAt: timestamp('deleted_at'), // Required for soft-delete
});
```

2. Export from `schema/index.ts`:

```typescript
export * from './posts';
```

3. Generate migration:

```bash
npm run db:generate
```

4. Create repository:

```typescript
// repositories/post.repository.ts
export class PostRepository extends BaseRepository<typeof posts> {
  constructor(db: Database) {
    super(db, posts);
  }
  
  // Add custom methods here
}
```

## Migrations

Migrations are auto-generated by Drizzle Kit based on schema changes.

### Generate Migration

```bash
npm run db:generate
```

### Apply Migrations

```bash
npm run db:migrate
```

### Push Schema (Development Only)

For rapid development without migration files:

```bash
npm run db:push
```

⚠️ **Warning**: `db:push` should only be used in development as it doesn't create migration history.

## Connection Management

The connection string is configured via `DATABASE_URL` environment variable:

```
DATABASE_URL=postgresql://user:password@host:port/database
```

For local development with Docker:

```
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/appdb
```
